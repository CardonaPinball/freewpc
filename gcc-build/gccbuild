#!/bin/sh

# The first time you build, you need to specify 'unpack' to extract
# the main gcc sources, and then 'patch' to apply a patch that tells
# the compiler about our new target.  Thereafter just run this script
# to build and install the compiler.
#

# After unpacking 4.0.1, you need to set up the symbolic link to force
# the m6809 config files into being.


VERSION=3.1.1
z=`pwd | grep 3.3.6`;
if [ "$?" = "0" ]; then
	VERSION=3.3.6
fi
z=`pwd | grep 3.4.4`;
if [ "$?" = "0" ]; then
	VERSION=3.4.4
fi
z=`pwd | grep 4.0.1`;
if [ "$?" = "0" ]; then
	VERSION=4.0.1
fi

whereis sudo >/dev/null 2>&1
if [ "$?" = "0" ]; then
	SUDO=sudo
fi

while [ "$1" != "" ]; do
arg=$1; shift
case $arg in
	ver3.3.6)
		VERSION=3.3.6
		;;
	ver4.0.1)
		VERSION=4.0.1
		;;
	asm-unpack)
		cd .. && zcat asm-6809.tar.gz | tar xvf -
		;;
	asm)
		cd ../asm-thomson && make clean && make && $SUDO make install
		;;

	unpack)
		cd .. && bzcat gcc-${VERSION}.tar.bz2 | tar xvf -
		;;

	patch)
		# This patch file only works for gcc 3.1.1
		# - add m6809 into config.sub
		# - add m6809-* into gcc/config.gcc
		# - add m6809-*-*) tm_file=m6809/m6809.h in gcc/config.gcc also
		cd .. && patch -p0 < m6809-gcc.diff
		# TODO : copy all files from ROOT/gcc-patch into ROOT/gcc-3.1.1/gcc
		;;

	config|configure)
		echo "Configuring gcc09 version $VERSION"
		../gcc-${VERSION}/configure --target=m6809 --program-suffix=09 --nfp --enable-obsolete
		;;

	clean)
		make clean LANGUAGES="c proto c++"
		;;

	*)
		echo "Building gcc09 version $VERSION"
		sleep 1
		rm -f gcc/xgcc*
		make cross LANGUAGES="c proto c++"
		if [ "$VERSION" = "4.0.1" ]; then
			GCC_SUBDIR=.
		else
			GCC_SUBDIR=gcc
		fi
		cd $GCC_SUBDIR && $SUDO make LANGUAGES="c proto c++" install
		echo "Copying new executable ... installation complete!"
		$SUDO mkdir -p /usr/local/m6809/bin
		$SUDO cp xgcc /usr/local/m6809/bin/gcc
		$SUDO cp xgcc /usr/local/m6809/bin/gcc-$VERSION
		echo "Done building"
		;;
esac
done

